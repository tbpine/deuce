@page
@model ScoringPageModel
@{
    Layout = "_LayoutAccount";
}
@using deuce
@using deuce.ext

<!-- Account listings content -->
<div class="col-lg-9">
<h1 class="h2 pb-2 pb-lg-3">@Model.Title</h1>

<!-- Nav pills -->
<div class="nav overflow-x-auto mb-2">
    <h1 class="h4 me-4 pb-2 pb-lg-3">Rounds</h1>
    <ul class="nav nav-pills flex-nowrap gap-2 pb-2 mb-1" role="tablist" id="pills_round">
    @for(int i = 1 ; i <=  @Model.NoRounds; i++){
        <li class="nav-item me-1" role="presentation">
        @{ string active = (i == (Model.CurrentRound+1) ? "active" : "");}                    
            <button type="button" class="nav-link text-nowrap @active" id="published-tab" data-bs-toggle="pill" data-bs-target="#published" role="tab" aria-controls="published"
            onclick="changeRound(@(i-1));" > 
        @i
            </button> 
        </li>
    }
    </ul>
</div>

<div class="tab-content">

    <!-- Published tab -->
    <div class="tab-pane fade show active" id="published" role="tabpanel" aria-labelledby="published-tab">

    <!-- Master checkbox + Action buttons -->
    <div class="nav align-items-center mb-4">
        <div class="d-flex flex-wrap" id="published-action-buttons">
            <a class="nav-link position-relative px-0 pe-sm-2 py-2 me-4" onclick="postAction('print')">
                <i class="fi-printer fs-base me-2"></i>
                <span class="hover-effect-underline stretched-link d-none d-md-inline">Print</span>
            </a>
        </div>
        <div class="d-flex flex-wrap" id="published-action-buttons">
            <a class="nav-link position-relative px-0 pe-sm-2 py-2 me-4" onclick="postAction('print_scores')">
                <i class="fi-printer fs-base me-2"></i>
                <span class="hover-effect-underline stretched-link d-none d-md-inline">Print Scores</span>
            </a>
        </div>
        <div class="d-flex flex-wrap" id="published-action-buttons">
            <a class="nav-link position-relative px-0 pe-sm-2 py-2 me-4" onclick="postAction('save')">
                <i class="fi-save fs-base me-2"></i>
                <span class="hover-effect-underline stretched-link d-none d-md-inline">Save</span>
            </a>
        </div>
        <div class="d-flex flex-wrap" id="published-action-buttons">
            <a class="nav-link position-relative px-0 pe-sm-2 py-2 me-4" href="#!">
                <i class="fi-refresh-ccw fs-base me-2"></i>
                <span class="hover-effect-underline stretched-link d-none d-md-inline">Reload</span>
            </a>
        </div>
        <div class="d-flex flex-wrap" id="published-action-buttons">
            <a class="nav-link position-relative px-0 pe-sm-2 py-2 me-4" href="#!" onclick="makeRandomScore()">
                <i class="fi-refresh-ccw fs-base me-2"></i>
                <span class="hover-effect-underline stretched-link d-none d-md-inline">Random</span>
            </a>
        </div>

    </div>

    <!-- Published listings -->
    <form asp-action="~/Scoring" method="post" id="mainForm">
        <input type="hidden" name="action" id="action"/>
        <input id="current_round" name="current_round" type="hidden" value="0"/>
        <div class="vstack gap-4" id="publishedSelection">
            @{int rIdx = 0;}
            @foreach(var perm in  Model.Rounds(Model.CurrentRound).Permutations)
            {
                rIdx++;
                <div>
                    <i class="fi-minus position-relative top-50 start-0 translate-middle-y" id="toogle_icon_round_@rIdx"></i>
                    <a class="btn btn-outline-secondary mb-3" href="#round_@rIdx" data-bs-toggle="collapse" role="button" aria-expanded="true" aria-controls="round_@rIdx"
                    onclick="toogleExpansion('toogle_icon_round_@rIdx')">
                    @perm.GetSummary()
                </a></div>
                <div class="collapse show" id="round_@rIdx" aria-expanded="true">
                
                    @for(int j = 0 ; j < perm.NoMatches; j++)
                    {
                        Match match = perm.GetMatchAtIndex(j);

                        //Find the score for this match
                        List<Score>? matchScores = Model.GetScore(Model.CurrentRound, perm.Id, match.Id);                    
                        <!-- Item -->
                        <div class="d-sm-flex align-items-center border mb-2 pb-2" >
                            <div class="d-inline-flex position-relative z-2 pt-1 pb-2 ps-2 p-sm-0 ms-2 ms-sm-0 me-sm-0 w-100"
                            style="height:120px;">
                                        @{
                                            int firstColWidth = Model.NoSets > 7 ? 4 : 5;
                                            int setColWidth = 1; 
                                        }

                                <div class="row w-100 ms-0">
                                    <div class="row">
                                        <div class="col-@firstColWidth mb-3 bg-body-secondary">@(match.GetTitle())</div>
                                        <!-- #headers  -->
                                        @for(int i = 0; i < Model.NoSets;i++)
                                        {
                                            <div class="col-@setColWidth mb-3 bg-body-secondary">@(i+1)</div>
                                        }
                                    </div>
                                    <div class="row">
                                        <div class="col-@firstColWidth pt-1" >@(match.GetHomeTeam())</div>
                                        @for(int i = 0; i < Model.NoSets;i++)
                                        {
                                            var setScore = i >= 0 && i < (matchScores?.Count() ?? 0) ? matchScores?.ElementAt(i) : null;
                                            <div class="col-@setColWidth">
                                                @if (match.IsByeMatch())
                                                {
                                                    <input class="form-control border-black p-1" name="home_@(setScore?.Id??0)_round_@(Model.CurrentRound)_perm_@(perm.Id)_match_@(match.Id)_set_@(i+1)" 
                                                    value="@(setScore?.Home)" disabled>
                                                }
                                                else
                                                {
                                                    <input  class="form-control border-black p-1"  name="home_@(setScore?.Id??0)_round_@(Model.CurrentRound)_perm_@(perm.Id)_match_@(match.Id)_set_@(i+1)" 
                                                    value="@(setScore?.Home)" >
                                                    
                                                }
                                            </div>
                                        }
                                        
                                    </div>
                                    <div class="row">

                                        <div class="col-@firstColWidth pt-1">@(match.GetAwayTeam())</div>
                                        @for(int i = 0; i < Model.NoSets;i++)
                                        {
                                            var setScore = i >= 0 && i < (matchScores?.Count() ?? 0) ? matchScores?.ElementAt(i) : null;
                                            <div class="col-@setColWidth">
                                                @if (match.IsByeMatch())
                                                {
                                                    <input  class="form-control border-black p-1" name="away_@(setScore?.Id??0)_round_@(Model.CurrentRound)_perm_@(perm.Id)_match_@(match.Id)_set_@(i+1)" 
                                                    value="@(setScore?.Away)" disabled>
                                                }
                                                else
                                                {
                                                    <input  class="form-control border-black p-1"  name="away_@(setScore?.Id??0)_round_@(Model.CurrentRound)_perm_@(perm.Id)_match_@(match.Id)_set_@(i+1)" 
                                                    value="@(setScore?.Away)" >
                                                    
                                                }
                                            </div>
                                        }
                                    </div>
                                    
                                </div>

                            </div>

                        
                        </div>
                    }
                </div>
            }

        </div>
    </form>
    </div>



</div>
</div>
<script src="~/js/scoring.js"></script>
